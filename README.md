# IsmSim：一个程序化意识形态模拟器

IsmSim 是一个复杂的、由数据驱动的模拟系统。它能够程序化地生成一个由NPC组成的社会，其中每个NPC都拥有独特且不断演化的心理和意识形态档案。项目背景设定在一个“哲学化的古代”世界，旨在探索个人信念、经济压力、社会关系和个人欲望如何相互作用，从而创造出一个动态且不断涌现的社会结构。

本模拟器基于客户端-服务器架构，拥有一个强大的Python后端来运行世界模拟，以及一个基于Godot的可视化前端。

## 核心特性

*   **动态的意识形态生命周期**: 这是当前系统的核心。NPC不再拥有单一、固定的意识形态，而是同时持有多种相互竞争的意识形态。他们的行为会反过来强化其核心信念，而被忽略的思潮则会逐渐消亡。当经历重大事件时，新的、激进的意识形态可能会“诞生”，导致NPC陷入“内在斗争”并最终完成人格的蜕变。
*   **深度的心理模型**: NPC的行为由一个三层体系驱动：(1) 生物性的**需求**（如饥饿）；(2) 意识形态驱动的**诉求**（源于其信仰的目标）；(3) 基于精神分析理论的**欲望**（深层的野心与创伤）。
*   **自运转的经济系统**: 世界拥有一套完整的经济循环。NPC在不同地点工作以生产资源、赚取金钱，并通过业余爱好制造商品，最终在市场出售。他们的财务状况（包括债务）会直接影响其压力水平和决策。
*   **涌现的社会动态**: NPC之间会根据互动形成复杂的关系（如同志、对手等）。这些由其核心意识形态决定的关系，主导了他们会信任谁、反对谁，以及在社交场合中的具体行为。
*   **数据驱动与可扩展性**: 模拟的几乎所有方面——从哲学信条、角色原型到地点、互动和可制造的物品——都由外部的JSON和Excel文件定义，这使得整个世界高度可定制和可扩展。

## 系统架构

*   **实体-组件-系统 (ECS)**: 模拟器的核心采用了ECS架构。这种设计将数据与逻辑分离，实现了高度的灵活性和性能。在ECS中，“系统”（如 `NeedsSystem`）会基于实体所拥有的“组件”（如 `FinancialComponent`）来执行相应的逻辑。
*   **客户端-服务器**:
    *   **世界服务器** (`world_server/`): 一个基于 `websockets` 的Python服务器，负责逐帧运行整个模拟。它处理所有NPC逻辑、世界事件和经济计算。
    *   **Godot 可视化工具** (`godot_visualizer/`): 一个Godot项目，它连接到世界服务器以接收世界状态更新，并实时渲染模拟画面。

## 如何开始

### 环境要求

*   Python 3.8+
*   Godot 引擎 (用于运行可视化工具)

### 安装

1.  克隆本仓库：
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```

2.  安装所需的Python依赖包：
    ```bash
    pip install -r requirements.txt
    ```

### 运行模拟

1.  **生成主义数据**: 如果 `isms_final.json` 文件缺失，或者你更新了源数据，请运行解析器：
    ```bash
    python excel_parser.py
    ```

2.  **启动世界服务器**:
    ```bash
    python -u world_server/server.py
    ```
    推荐使用 `-u` 标志来禁用输出缓冲，以便实时查看日志。服务器将启动并监听 `ws://localhost:8765`。

3.  **运行可视化工具**:
    *   在Godot引擎中打开 `godot_visualizer/` 项目。
    *   运行主场景。客户端将自动尝试连接到正在运行的服务器。

## NPC核心机制：生成、动机与互动

这是一个高度动态的系统，决定了每个NPC的身份、行为以及他们如何与世界及他人互动。

### 1. NPC的诞生：从环境到内心

NPC的生成过程深度模拟了一个人如何被其环境和经历所塑造，从而形成复杂且时常矛盾的内心世界。这取代了旧有的、基于固定原型的简单逻辑。

1.  **播种 (Seeding)**: 每个NPC都出生在世界的某个特定区域（定义于 `regions.json`）。该区域拥有一个“文化模因池” (`MemePool`)，其中包含了一系列在该地流行的意识形态ID。这构成了NPC最初可能接触到的思想基础。

2.  **生成传记 (Biography Generation)**: 在选择意识形态之前，系统会为NPC生成一份个人传记 (`biography_generator.py`)。这份传记包含关键标签，如：
    *   `social_class` (社会阶层): 例如“无产者”、“卫兵”、“学者”。
    *   `education` (教育水平): 例如“无”、“基础教育”、“高等教育”。
    *   `defining_event` (决定性事件): 一个可能塑造其世界观的关键经历，例如“目睹长官腐败”或“在海难中幸存”。

3.  **过滤与生成 (Filtering & Generation)**: 系统使用这份传记 (`mind_generator.py`) 来塑造NPC的意识形态：
    *   **主要主义**: 系统会根据传记标签（如教育水平）过滤文化模因池，然后加权随机选择一个作为NPC的**主要意识形态**，并赋予其较高的“强度”（如0.8）。这代表了NPC被动接受的环境“思想钢印”。
    *   **次要主义 (内在矛盾)**: 为了创造有深度的角色，系统会植入一个**次要意识形态**。其来源通常是“决定性事件”。例如，一个在神权国家长大、拥有“神义论”主要主义的卫兵，如果经历了“目睹长官腐败”事件，系统会强行植入一个低强度（如0.3）的“现代犬儒主义”作为其次要思想。

最终，一个NPC的“心智” (`IsmComponent`) 由这两种或多种意识形态构成，其内在的冲突将直接驱动其未来的决策与行为。

### 2. 动机引擎：需求、诉求与欲望

NPC的行为由一个复杂的三层动机模型驱动：

*   **需求 (Needs)**: 最底层是生物性需求，如 `饥饿`、`精力` 和 `压力`。这些是生存的基本驱动力，由 `NeedsSystem` 管理。当需求不满时，会产生最优先的行为目标（如寻找食物）。
*   **诉求 (Demands)**: 中间层是源于其意识形态的社会性目标。`MotivationSystem` 会解析NPC的 `IsmComponent`，根据其信仰生成高级诉求。例如，一个信奉集体主义的NPC可能会产生“参与公共劳动”的诉求，而一个个人主义者则可能想要“积累个人财富”。
*   **欲望 (Desires)**: 最高层是最复杂的心理驱动力，由 `DesireSystem` 基于拉康派精神分析理论生成。它分为三个维度：
    *   **想象界 (Imaginary)**: 在满足一个诉求后产生的不断升级的欲望。例如，成功卖掉一件手工艺品后，会产生“赚更多钱”的欲望。
    *   **象征界 (Symbolic)**: 对社会承认或否定的反应。例如，在与人形成“对手”关系后，会产生“在竞争中击败对方”的欲望。
    *   **实在界 (Real)**: 由创伤驱动的、颠覆性的冲动，旨在挑战或摧毁痛苦的根源。

### 3. 互动逻辑：关系、决策与影响

NPC之间的互动并非随机，而是由其内在逻辑和外部关系共同决定的。

*   **决策**: 当一个NPC决定与另一个NPC互动时，`InteractionSystem` 会评估其 `final_decision_matrix`（由其所有意识形态加权平均得出）。矩阵的不同维度会影响其社交倾向（例如，更倾向于合作还是对抗）。
*   **关系**: 互动的结果会影响NPC之间的关系，存储于 `RelationshipComponent`。根据 `relationship_types.json` 中定义的规则（基于亲和度、互动关键词等），他们可以形成“同志”、“对手”、“朋友”等具名关系。
*   **影响**: 这些关系会反过来影响未来的互动。例如，NPC会优先与“同志”进行合作性互动，并可能拒绝与“对手”进行任何友好交流。此外，成功的互动还会为NPC提供“意识形态经验值”（IXP），用于强化或演化其思想。

### 4. 与世界的互动：经济与生活

NPC是这个世界经济体中活跃的参与者：

*   **工作与生产**: NPC会在 `WORKPLACE` 类型的地点工作以赚取金钱，同时为世界生产资源（如谷物、矿石）。这一过程由 `ResourceManager` 统一管理。
*   **消费与满足**: 他们会前往 `FOOD_SOURCE` 或 `ENTERTAINMENT` 等地点消费，以满足其“饥饿”或“压力”等需求。
*   **金融活动**: `BankingSystem` 允许NPC在银行存钱或申请贷款，他们的财务状况（特别是债务）会直接影响其压力水平。
*   **爱好与创造**: 通过 `HobbySystem`，NPC可以追求个人爱好（如绘画、炼金），这不仅能满足其精神需求，还能创造出可以拿到 `MARKETPLACE` 出售的商品，从而形成一个完整的生产-消费循环。

## 核心系统详解：意识形态生命周期

这是NPC心智的核心，也是我们当前工作的重点成果。它取代了过去静态的“突变”模型。

*   **内在斗争 (Internal Struggle)**: NPC的最终决策矩阵是其所有活跃意识形态，根据各自的“强度”进行加权平均后的结果。一个拥有两种强大且对立的意识形态的NPC，其行为将充满矛盾且难以预测。
*   **诞生 (Birth)**: 当一个NPC在某种新的思维方式上获得了足够的经验（IXP）后，一个新的意识形态会从其主导思想中“诞生”。母体思想的强度会与新生的子思想进行分配（例如，49% vs 51%），从而立即创造出一场内心冲突。
*   **强化 (Reinforcement)**: 当NPC执行一个行动时（如“工作”、“抗议”、“创作艺术”），与该行动关联的关键词会强化相应的意识形态，增加其强度，固化其信念。
*   **遗忘与死亡 (Decay & Death)**: 没有被行动所强化的意识形态，其强度会缓慢衰减。如果一个意识形态的强度降至某个阈值以下，它就被判定为“死亡”，并被NPC彻底遗忘。这是NPC经历漫长时间真正改变想法的方式。